<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drag-to-Category Study</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --brand: #4f46e5;
      --ok: #10b981;
      --warn: #f59e0b;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body { margin:0; background: var(--bg); color: var(--ink);
           font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    header { position: sticky; top:0; z-index: 10; background: rgba(255,255,255,0.85);
             backdrop-filter: blur(6px); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 12px 16px; }
    h1 { font-size: 20px; margin: 0; }
    .controls { display: flex; gap: 8px; margin-left: auto; }
    button { border: 0; padding: 8px 12px; border-radius: 10px; color: white;
             background: var(--ink); cursor: pointer; box-shadow: 0 1px 2px rgba(16,24,40,.04); }
    button:hover { filter: brightness(0.95); }
    .btn-primary { background: var(--brand); }
    .btn-warn { background: var(--warn); }

    main { max-width: 1100px; margin: 0 auto; padding: 16px; display: grid;
           grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px){ main { grid-template-columns: 2fr 3fr; } }

    .panel { background: var(--panel); border: 1px solid var(--border);
             border-radius: 14px; padding: 12px; }
    .panel h2 { margin: 0 0 8px; font-size: 18px; }

    .bank, .category { min-height: 96px; border: 1px solid var(--border);
                       border-radius: 12px; background: #fff; padding: 10px; }
    .bank.over, .category.over { outline: 3px solid #c7d2fe; border-color: var(--brand);
                                 background: #eef2ff; }

    .chip { display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px;
            background: #fff; margin: 4px; font-size: 14px; cursor: grab;
            user-select: none; box-shadow: 0 1px 2px rgba(16,24,40,.04); }
    .chip.locked { opacity: .75; cursor: default; }
    .chip.ghost { border-style: dashed; color: var(--muted); background: #fafafa; }

    .cats { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 600px){ .cats { grid-template-columns: 1fr 1fr; } }

    .cat-card { background:#fff; border: 1px solid var(--border);
                border-radius: 14px; overflow: hidden; }
    .cat-head { display:flex; align-items:center; justify-content:space-between;
                padding: 8px 10px; border-bottom: 1px solid var(--border);
                font-weight: 600; }
    .cat-count { font-weight: 500; font-size: 12px; color: var(--muted); }

    .row { display: flex; gap: 12px; align-items: center; }
    .spacer { flex: 1; }

    textarea { width: 100%; height: 180px; border-radius: 12px;
               border: 1px solid var(--border); padding: 10px; resize: vertical; }
    .hint { color: var(--muted); font-size: 13px; }
    .small { color: var(--muted); font-size: 14px; }
  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>Drag-to-Category Study</h1>
    <div class="spacer"></div>
    <div class="controls">
      <button class="btn-primary" id="btnCheck">Check</button>
      <button id="btnToggleAns">Show Answers</button>
      <button class="btn-warn" id="btnUnlock">Unlock All</button>
      <button id="btnReset">Reset & Shuffle</button>
    </div>
  </div>
</header>

<main>
  <section class="panel">
    <h2>Items</h2>
    <div id="bank" class="bank" aria-label="Item bank"></div>
    <p class="small">Drag items into the correct category boxes. Click <b>Check</b> to lock correct items; wrong ones return here.</p>
  </section>

  <section class="panel">
    <h2>Categories</h2>
    <div id="cats" class="cats"></div>
  </section>

  <section class="panel" style="grid-column: 1 / -1;">
    <h2>Dataset (whitespace-indented)</h2>
    <textarea id="dataset"></textarea>
    <p class="hint">Deepest-indented lines are <em>items</em>. Every ancestor level is a <em>category</em>.</p>
  </section>
</main>

<script>
const defaultText = `Congenital heart defects
	Acyanotic
		Increased pulmonary flow
			Atrial Septal Defect
			Ventricular Septal Defect (most common acyanotic)
			Patent ductus arteriosus
		Obstruction to blood flow from ventricles
			Coarctation of aorta
			Aortic stenosis
			Pulmonic stenosis
	Cyanotic
		Decreased pulmonary blood flow
			Tetralogy of fallot (most common cyanotic)
				Pulmonic stenosis
				Right ventricular hypertrophy
				Overriding aorta
				Ventricular septal defect
			Tricuspid atresia
		Mixed blood flow
			Transposition of the great arteries
			Total anomalous pulmonary venous return
			Truncus arteriosus
			Hypoplastic left heart syndrome`;

let leaves=[],categories=[],groups={},bank=[],placed={},locked=new Set(),showAnswers=false,seed=1;
const elDataset=document.getElementById('dataset'),elBank=document.getElementById('bank'),
elCats=document.getElementById('cats'),btnCheck=document.getElementById('btnCheck'),
btnUnlock=document.getElementById('btnUnlock'),btnReset=document.getElementById('btnReset'),
btnToggleAns=document.getElementById('btnToggleAns');
elDataset.value=defaultText;

const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
let UID=0; const uid=l=>`${slug(l)}-${UID++}`;
function rng(){let x=seed%2147483647;return()=> (x=x*48271%2147483647)/2147483647;}
function shuffle(a){const r=rng(),arr=a.slice();for(let i=arr.length-1;i>0;i--){const j=Math.floor(r()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}
function countDepth(indent){if(!indent)return 0;const t=(indent.match(/\\t/g)||[]).length;const s=indent.replace(/\\t/g,'').length;return t+Math.floor(s/2);}

function parseIndented(text){
 const lines=text.split(/\\r?\\n/).map(l=>l.replace(/\\s+$/,'')).filter(l=>l.trim().length>0);
 const items=lines.map(line=>{const m=/^([\\t ]*)(.*)$/.exec(line);const indent=m[1]||'';const label=(m[2]||'').trim();return{depth:countDepth(indent),node:{label,children:[]}}});
 const root={label:items[0]?.node.label||'Root',children:[]};const stack=[{depth:-1,node:root}];
 for(const {depth,node} of items){while(stack.length&&stack[stack.length-1].depth>=depth)stack.pop();
 const p=stack[stack.length-1].node;if(depth===0&&root.children.length===0)root.label=node.label;else p.children.push(node);stack.push({depth,node});}
 return{root};
}
function annotate(root){(function w(n,d=-1,p=null){n._depth=d;n._parent=p;(n.children||[]).forEach(ch=>w(ch,d+1,n));})(root);}
function walk(n,fn){fn(n);(n.children||[]).forEach(ch=>walk(ch,fn));}
function deepestDepth(root){let m=0;walk(root,n=>{if(n._depth>m)m=n._depth});return m;}
function collectDescendantLeafIds(n,td){let out=[];if(!n.children||n.children.length===0){if(n._depth===td)out.push(n._leafId);return out;}for(const c of n.children)out=out.concat(collectDescendantLeafIds(c,td));return out;}
function labelOf(id){return(leaves.find(l=>l.id===id)||{}).label||id;}

function renderBank(){elBank.innerHTML='';bank.forEach(id=>{const d=document.createElement('div');d.className='chip';d.draggable=!locked.has(id);if(locked.has(id))d.classList.add('locked');d.textContent=(locked.has(id)?'✅ ':'')+labelOf(id);d.dataset.id=id;d.addEventListener('dragstart',onDragStart);elBank.appendChild(d);});}
function renderCats(){
 elCats.innerHTML='';categories.forEach(cat=>{const card=document.createElement('div');card.className='cat-card';
 const head=document.createElement('div');head.className='cat-head';head.innerHTML=`<div>${cat.label}</div><div class=\"cat-count\" id=\"count-${cat.id}\"></div>`;
 const zone=document.createElement('div');zone.className='category';zone.dataset.catId=cat.id;
 zone.addEventListener('dragover',onZoneDragOver);zone.addEventListener('dragleave',onZoneDragLeave);zone.addEventListener('drop',onZoneDrop);
 (placed[cat.id]||[]).forEach(id=>zone.appendChild(makeChip(id)));
 if(showAnswers){const answers=groups[cat.id]||[];const miss=answers.filter(id=>!(placed[cat.id]||[]).includes(id));
 miss.forEach(id=>{const g=document.createElement('div');g.className='chip ghost';g.textContent=labelOf(id);zone.appendChild(g);});}
 const wrap=document.createElement('div');wrap.className='panel';wrap.style.border='none';wrap.style.padding='10px';wrap.appendChild(zone);
 card.appendChild(head);card.appendChild(wrap);elCats.appendChild(card);updateCount(cat.id);});
}
function makeChip(id){const d=document.createElement('div');d.className='chip';d.draggable=!locked.has(id);if(locked.has(id))d.classList.add('locked');d.textContent=(locked.has(id)?'✅ ':'')+labelOf(id);d.dataset.id=id;d.addEventListener('dragstart',onDragStart);return d;}
function updateCount(cid){const t=(groups[cid]||[]).length;const c=(placed[cid]||[]).filter(id=>(groups[cid]||[]).includes(id)).length;const el=document.getElementById(`count-${cid}`);if(el)el.textContent=`${c} / ${t}`;}

function onDragStart(e){e.dataTransfer.setData('text/plain',e.target.dataset.id);}
function onZoneDragOver(e){e.preventDefault();e.currentTarget.classList.add('over');}
function onZoneDragLeave(e){e.currentTarget.classList.remove('over');}
function onZoneDrop(e){e.preventDefault();e.currentTarget.classList.remove('over');const id=e.dataTransfer.getData('text/plain');if(!id||locked.has(id))return;
 const cid=e.currentTarget.dataset.catId;bank=bank.filter(x=>x!==id);for(const k of Object.keys(placed))placed[k]=placed[k].filter(x=>x!==id);placed[cid]=(placed[cid]||[]).concat(id);renderBank();renderCats();}
elBank.addEventListener('dragover',e=>{e.preventDefault();elBank.classList.add('over');});
elBank.addEventListener('dragleave',()=>elBank.classList.remove('over'));
elBank.addEventListener('drop',e=>{e.preventDefault();elBank.classList.remove('over');const id=e.dataTransfer.getData('text/plain');if(!id||locked.has(id))return;
 for(const k of Object.keys(placed))placed[k]=placed[k].filter(x=>x!==id);if(!bank.includes(id))bank.push(id);renderBank();renderCats();});

btnCheck.addEventListener('click',()=>{const wrong=[];for(const[cid,ids]of Object.entries(placed)){ids.forEach(id=>{if((groups[cid]||[]).includes(id))locked.add(id);else wrong.push(id);});}
 for(const id of wrong){for(const k of Object.keys(placed))placed[k]=placed[k].filter(x=>x!==id);if(!bank.includes(id))bank.push(id);}renderBank();renderCats();});
btnUnlock.addEventListener('click',()=>{locked=new Set();renderBank();renderCats();});
btnReset.addEventListener('click',()=>{seed++;initFromText(elDataset.value);});
btnToggleAns.addEventListener('click',()=>{showAnswers=!showAnswers;btnToggleAns.textContent=showAnswers?'Hide Answers':'Show Answers';renderCats();});
let t;elDataset.addEventListener('input',()=>{clearTimeout(t);t=setTimeout(()=>initFromText(elDataset.value),150);});

function initFromText(text){
 UID=0;locked=new Set();showAnswers=false;btnToggleAns.textContent='Show Answers';
 const {root}=parseIndented(text);annotate(root);const maxD=deepestDepth(root);
 leaves=[];groups={};placed={};bank=[];categories=[];
 walk(root,n=>{if(n._depth===maxD&&(!n.children||n.children.length===0)){n._leafId=uid(n.label);leaves.push({id:n._leafId,label:n.label});}});
 const seen=new Set();walk(root,n=>{if(n._depth>=0&&n._depth<maxD){const cid=slug(n.label);if(!seen.has(cid)){const ids=collectDescendantLeafIds(n,maxD);if(ids.length){categories.push({id:cid,label:n.label});groups[cid]=ids.slice();}seen.add(cid);}}});
 bank=shuffle(leaves.map(l=>l.id));renderBank();renderCats();
}
initFromText(defaultText);
</script>
</body>
</html>
